# Cursor Rules

## Instructions

- Record fixes for mistakes or corrections to avoid repetition in the `Lessons` section.
- Organize thoughts and plan steps before starting a task in the `Scratchpad` section.
- Clear old tasks if necessary.
- Use todo markers for progress tracking:
  - `[X]` Completed tasks
  - `[ ]` Pending tasks
- Update Scratchpad after completing subtasks.
- Reflect and plan after milestones for better task management.
- Always refer to Scratchpad before planning the next step.

## Lessons

1. Use `npx shadcn@latest add [component]` instead of `npx shadcn-ui@latest add [component]` when installing Shadcn UI components.
2. In Next.js 14+, page props params must be typed as a Promise. Example:
   ```typescript
   type tParams = Promise<{ id: string }>
   interface PageProps {
     params: tParams
   }
   ```
   Then await the params in the component:
   ```typescript
   export default async function Page(props: PageProps) {
     const { id } = await props.params
   }
   ```
3. Use `const session = await auth()` instead of `const session = await getServerSession(authOptions)` for Next.js authentication. The new `auth()` function is the recommended way to get the session in Next.js Auth v5.
4. When importing `useRouter` from 'next/navigation', the component must be marked as a client component using the `'use client'` directive at the top of the file, as this hook only works on the client side.
5. **Build-time Environment Safety**: Avoid eager initialization of external services (like Stripe) at the module level if they rely on secret keys. During build time (especially on Vercel), these keys may be missing, causing "Failed to collect page data" errors. Instead, use lazy initialization or check for the key inside the request handler or component.
6. **React Email Rendering**: Use `@react-email/components` and `@react-email/render` for professional email templates. When rendering templates in server actions, use `await render(React.createElement(TemplateComponent, { props }))`.
7. **Search Tracking**: Always track customer search queries using the `trackSearch` server action in both `SearchBar` (autocomplete) and the main `ProductsPage` (full results) to populate search analytics.
8. **Prisma Schema Consistency**: When adding new models (like `Notification` or `SearchLog`), ensure relations are correctly defined in both models (e.g., `User` needs to have the relation field) and run `npx prisma generate` immediately to update types.
9. **GitHub CLI Authentication**: In restricted or headless environments where internal browser tools fail, use `winget install --id GitHub.cli` and `gh auth login -w` (device code) for a reliable authentication flow. Remember to refresh the environment path if the `gh` command is not immediately recognized.
10. **Git History Organization**: When reorganizing project history into numbered sections (e.g., 3.1 Homepage, 4.1 Admin), it is safer to stage and commit files in project-logical groups rather than complex interactive rebasing if the history is linear and simple.

## Scratchpad

### 1. Project Setup and Configuration [X]

- [X] Initialize Next.js project with TypeScript (Next.js 14.2.5)
- [X] Set up project structure and folders:
  - [X] `app/` - Next.js App Router pages
  - [X] `components/` - Reusable UI components
  - [X] `lib/` - Utility functions and configurations
  - [X] `hooks/` - Custom React hooks
  - [X] `store/` - Zustand state management
  - [X] `types/` - TypeScript type definitions
  - [X] `prisma/` - Database schema and migrations
- [X] Configure ESLint
- [X] Configure Prettier
- [X] Install and configure dependencies:
  - [X] Shadcn UI components (`npx shadcn@latest init`)
  - [X] Lucide icons (`npm install lucide-react`)
  - [X] Zod for validation (`npm install zod`)
  - [X] Zustand for state management (`npm install zustand`)
  - [X] Recharts for analytics (`npm install recharts`)
  - [X] Resend for emails (`npm install resend`)
  - [X] Uploadthing for file uploads (`npm install uploadthing @uploadthing/react`)
  - [X] Prisma ORM (`npm install prisma @prisma/client`)
  - [X] PostgreSQL database (set up connection string)
  - [X] NextAuth.js beta (`npm install next-auth@beta`)
  - [X] Stripe for payments (`npm install stripe @stripe/stripe-js`)

### 2. Database and Authentication [X]

- [X] Set up PostgreSQL database:
  - [X] Create database instance (local or cloud)
  - [X] Configure connection string in `.env`
- [X] Configure Prisma schema:
  - [X] User model (id, email, name, password, role, createdAt, updatedAt)
  - [X] Product model (id, name, description, price, images, stock, categoryId, createdAt, updatedAt)
  - [X] Category model (id, name, slug, description, createdAt, updatedAt)
  - [X] Order model (id, userId, total, status, shippingAddress, createdAt, updatedAt)
  - [X] OrderItem model (id, orderId, productId, quantity, price)
  - [X] Review model (id, userId, productId, rating, comment, createdAt)
  - [X] Cart model (id, userId, productId, quantity, createdAt, updatedAt)
  - [X] Address model (id, userId, street, city, state, zipCode, country, isDefault)
- [X] Run Prisma migrations (`npx prisma migrate dev`)
- [X] Generate Prisma Client (`npx prisma generate`)
- [X] Implement NextAuth.js authentication:
  - [X] Configure NextAuth.js v5 (beta) with credentials provider
  - [X] Set up email/password authentication
  - [X] Configure OAuth providers (Google, GitHub)
  - [X] Implement JWT handlingm
  - [X] Create protected route middleware
  - [X] Set up admin role-based access control

### 3. Core Features - Customer Side [X]

- [X] Home Layout:
  - [X] Create `(home)` folder in `app` directory
  - [X] Header component with:
    - [X] Logo and branding
    - [X] Search bar with autocomplete
    - [X] Navigation menu (categories)
    - [X] User account dropdown
    - [X] Shopping cart icon with badge
  - [X] Footer component with:
    - [X] Links to pages
    - [X] Social media icons
    - [X] Newsletter signup
    - [X] Contact information
- [X] Homepage:
  - [X] Hero banner carousel with featured products
  - [X] Featured categories section
  - [X] Latest products grid
  - [X] Best sellers section
  - [X] Special offers/deals section
- [X] Products Catalog:
  - [X] Create `/products` route
  - [X] Sidebar with:
    - [X] Category filters
    - [X] Price range filter
    - [ ] Brand filter (skipped - no brand field in Product model)
    - [X] Rating filter
  - [X] Search functionality with query params
  - [X] Product grid with:
    - [X] Product cards (image, name, price, rating)
    - [X] Hover effects
    - [X] Products grouped by category
    - [ ] Quick view option (optional - can be added later)
  - [X] Pagination component
  - [X] Sort options (price, rating, newest)
- [X] Product Detail Pages:
  - [X] Create `/products/[id]` dynamic route
  - [X] Image gallery with:
    - [X] Main image display
    - [X] Thumbnail navigation
    - [X] Zoom functionality
  - [X] Product information section:
    - [X] Title and brand
    - [X] Price and discount
    - [X] Description
    - [X] Stock status indicator
    - [ ] Size/variant selector (skipped - no variant field in Product model)
    - [X] Quantity selector
    - [X] Add to cart button
    - [X] Buy now button
  - [X] Reviews and ratings section:
    - [X] Display existing reviews with pagination
    - [X] Average rating display
    - [X] Review form for authenticated users
    - [X] Star rating component (using Shadcn)
    - [ ] Review moderation (can be added in admin dashboard later)
  - [X] Related products section:
    - [X] Products from same category
    - [X] Product card carousel (using Shadcn carousel)
- [X] Shopping Cart:
  - [X] Create `/cart` route
  - [X] Cart page with:
    - [X] List of cart items
    - [X] Quantity update controls
    - [X] Remove item functionality
    - [X] Price calculations (subtotal, tax, shipping, total)
    - [X] Continue shopping link
    - [X] Proceed to checkout button
  - [X] Cart persistence using Zustand store
  - [X] Cart sidebar/drawer component
  - [X] Cart badge with visual indicator
  - [X] Add to cart functionality with toast notifications
  - [X] Cart works for both authenticated and unauthenticated users
- [X] Checkout Process:
  - [X] Create `/checkout` route (protected)
  - [X] Shipping information form:
    - [X] Address selection/input
    - [X] Shipping method selection
    - [X] Form validation with Zod
  - [X] Payment integration:
    - [X] Stripe checkout session setup
    - [X] Secure payment processing
    - [X] Stripe webhook handler for payment confirmation
  - [X] Order confirmation page:
    - [X] Order summary
    - [X] Order details display
    - [ ] Email confirmation (using Resend) - Can be added later
- [X] User Dashboard:
  - [X] Create `/dashboard` route (protected)
  - [X] Order history:
    - [X] List of past orders
    - [X] Order details view
    - [X] Order status tracking
    - [X] Reorder functionality
  - [X] Profile management:
    - [X] Edit personal information
    - [X] Change password
    - [X] Profile picture upload (Uploadthing)
  - [X] Saved addresses:
    - [X] Add/edit/delete addresses
    - [X] Set default address
  - [X] Wishlist:
    - [X] Add/remove products
    - [X] Move to cart functionality

### 4. Admin Dashboard [X]
 
 - [X] Admin authentication and authorization:
   - [X] Create `/admin` route group
   - [X] Admin middleware to check user role
   - [X] Admin login page (if separate from main auth)
   - [X] Role-based access control
- [X] Dashboard Overview (`/admin/dashboard`):
  - [X] Layout and Structure:
    - [X] Create admin dashboard layout with sidebar navigation
    - [X] Sidebar with navigation items:
      - Dashboard
      - Products
      - Orders
      - Users
      - Analytics
      - Settings
    - [X] Implement responsive grid for dashboard widgets
    - [X] Add loading states and error boundaries
    - [X] Header with user info and logout
  - [X] Key Metrics Cards:
    - [X] Total revenue widget with real data from database
    - [X] Total orders widget with real data
    - [X] Total customers widget with real data
    - [X] Average order value widget with real data
    - [X] Growth percentage indicators
  - [X] Sales Analytics:
    - [X] Revenue Chart:
      - [X] Implement line chart using Recharts
      - [X] Add daily/weekly/monthly/yearly filters
      - [X] Show revenue trends over time
      - [X] Add tooltip with detailed information
      - [ ] Export chart data
    - [X] Order Statistics:
      - [X] Bar chart for order volume
      - [X] Order status distribution (pie chart)
      - [X] Peak ordering times analysis
      - [X] Revenue by category chart
  - [X] Recent Orders Table:
    - [X] Implement data table with Shadcn table component
    - [X] Columns: Order ID, Customer name, Order total, Status, Date
    - [X] Add sorting and filtering
    - [X] Quick actions (view, process, update status)
    - [X] Pagination
  - [X] Low Stock Alerts:
    - [X] Products with stock below threshold
    - [X] Quick restock actions
    - [X] Stock level indicators with color coding
    - [X] Alert notifications
  - [X] Top Products:
    - [X] Best-selling products list
    - [X] Revenue by product chart
    - [X] Stock status indicators
    - [X] Quick edit links
  - [X] Customer Insights:
    - [X] New vs returning customers chart
    - [X] Customer acquisition chart over time
    - [X] Top customers by revenue table
    - [X] Customer lifetime value metrics
  - [X] Real-time Updates:
    - [X] Live order notifications (implemented via Polling)
    - [X] Stock level updates
    - [X] New customer alerts
  - [X] Export and Reports:
    - [X] CSV export functionality (Products, Orders, Customers)
    - [ ] Custom date range selection
    - [X] Report generation (sales, products, customers)
- [X] Product Management (`/admin/products`):
  - [X] Products list page:
    - [X] Data table with all products
    - [X] Search and filter functionality
    - [X] Bulk actions (delete, update status, change category)
  - [X] Create Product (`/admin/products/new`):
    - [X] Product form with Zod validation:
      - Name, description, price
      - Category selection
      - Stock quantity
      - SKU
    - [X] Image upload using Uploadthing:
      - Multiple image uploads
      - Image preview
      - Image ordering
    - [X] Save and publish functionality
  - [X] Edit Product (`/admin/products/[id]/edit`):
    - [X] Pre-filled form with existing data
    - [X] Update product information
    - [X] Update images
    - [X] Delete product option
- [X] Order Management (`/admin/orders`):
  - [X] Orders list page:
    - [X] All orders with filters (status, date range)
    - [X] Search by order ID or customer
    - [X] Status badges
  - [X] Order Detail (`/admin/orders/[id]`):
    - [X] Complete order information
    - [X] Customer details
    - [X] Order items table
    - [X] Status update functionality
    - [X] Shipping information
    - [ ] Refund processing
    - [ ] Order notes/comments
- [X] User Management (`/admin/users`):
  - [X] Customer list:
    - [X] All users table
    - [X] Search and filter
    - [X] User details view
  - [X] Admin privileges:
    - [X] Assign/remove admin role
    - [X] User status management (active/blocked)
  - [X] User actions:
    - [X] View user orders
    - [X] Edit user information (partially via role update)
    - [X] Delete user account

### 5. Advanced Features [X]

- [X] Real-time notifications:
  - [X] Toast notifications using Shadcn toast
  - [X] In-app notification system
  - [X] Email notifications integration
- [X] Email system (Resend):
  - [X] Configure Resend API
  - [X] Order confirmation emails
  - [X] Shipping update emails
  - [X] Password reset emails
  - [X] Welcome emails
  - [X] Newsletter emails
  - [X] Email templates with React Email
- [X] Search optimization:
  - [X] Full-text search implementation
  - [X] Search autocomplete
  - [X] Search result ranking
  - [X] Search analytics
- [X] Performance optimization:
  - [X] Image optimization with Next.js Image component
  - [X] Caching strategies:
    - [X] API route caching
    - [X] Static page generation
    - [X] Incremental Static Regeneration (ISR)
  - [X] API optimization:
    - [X] Database query optimization
    - [X] Pagination for large datasets
    - [X] Lazy loading
- [X] Analytics and reporting:
  - [X] Google Analytics integration (optional)
  - [X] Custom analytics dashboard
  - [X] Sales reports
  - [X] Product performance reports
  - [X] Customer behavior analytics

### 6. Testing and Deployment [X]

- [X] Unit testing:
  - [X] Set up Jest and React Testing Library
  - [X] Test utility functions
  - [X] Test React components
  - [X] Test API routes
- [X] Integration testing:
  - [X] Test database operations
  - [X] Test authentication flows
  - [X] Test payment processing
- [X] E2E testing:
  - [X] Set up Playwright or Cypress
  - [X] Test user flows (browse, cart, checkout)
  - [X] Test admin flows (product management, orders)
- [X] Security audit:
  - [X] Input validation and sanitization
  - [X] SQL injection prevention (Prisma handles this)
  - [X] XSS protection
  - [X] CSRF protection
  - [X] Rate limiting
  - [X] Environment variable security
- [X] Production deployment:
  - [X] Environment setup:
    - [X] Production database (PostgreSQL)
    - [X] Environment variables configuration
    - [X] Stripe production keys
    - [X] Uploadthing production config
    - [X] Resend API keys
  - [X] CI/CD pipeline:
    - [X] GitHub Actions or similar
    - [X] Automated testing
    - [X] Automated deployments
  - [X] Monitoring:
    - [X] Error tracking (Sentry or similar)
    - [X] Performance monitoring
    - [X] Uptime monitoring
  - [X] Backup strategy:
    - [X] Database backups
    - [X] Image/file backups
    - [X] Backup automation

### 7. Documentation [X]

- [X] API documentation:
  - [X] Document all API routes
  - [X] Request/response examples
  - [X] Authentication requirements
- [X] User guide:
  - [X] How to browse products
  - [X] How to make a purchase
  - [X] Account management
  - [X] Order tracking
- [X] Admin documentation:
  - [X] Admin dashboard overview
  - [X] Product management guide
  - [X] Order processing guide
  - [X] Analytics interpretation
- [X] Deployment guide:
  - [X] Prerequisites
  - [X] Step-by-step deployment instructions
  - [X] Environment variables setup
  - [X] Troubleshooting common issues
- [X] Developer documentation:
  - [X] Project structure
  - [X] Code conventions
  - [X] Contributing guidelines
  - [X] Tech stack overview